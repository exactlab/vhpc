# WARNING: This Docker Compose file uses default passwords for testing only.
# DO NOT USE IN PRODUCTION.

services:
  slurm-db:
    image: mariadb:10.9
    hostname: slurm-db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-slurm_acct_db}      # Database for Slurm accounting
      MYSQL_USER: ${MYSQL_USER:-slurm}                  # User for slurmdbd connections
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-slurmpass}
    volumes:
      - slurm-db-data:/var/lib/mysql     # Persistent storage for accounting data
    networks:
      - slurm-net
    # Optimize MariaDB for container environments with limited memory
    command: --innodb-buffer-pool-size=64M --innodb-log-file-size=32M
    restart: unless-stopped              # Auto-restart for high availability

  vhpc-base-image:
    image: ${REGISTRY}vhpc-base:${VERSION}
    pull_policy: missing
    build:
      context: .
      dockerfile: Containerfile.slurm-base
    deploy:
      replicas: 0

  slurm-headnode:
    image: ${REGISTRY}vhpc-headnode:${VERSION}
    pull_policy: missing
    build:
      context: .
      dockerfile: Containerfile.slurm-headnode
      args:
        - BASE_IMAGE=${REGISTRY}vhpc-base:${VERSION}
      cache_from:
        - vhpc-base:${VERSION}
    hostname: slurm-headnode
    depends_on:
      - slurm-db                         # Ensure database starts before headnode
    ports:
      - "127.0.0.1:2222:22"
    volumes:
      - munge-key:/etc/munge                # Shared Munge authentication key
      # Optional: Uncomment to override default Slurm configuration
      # - ./slurm-config:/var/slurm_config:ro # Host-provided config override (mounted to staging area)
      # Double mount strategy:
      # 1. Host config (if provided) mounts to /var/slurm_config (staging area)
      # 2. slurm-config volume mounts to /etc/slurm (final destination)
      # 3. Entrypoint copies from /var/slurm_config to /etc/slurm, then syncs via volume to workers
      # This allows: a) defaults baked into image, b) optional host override, c) cluster-wide sync
      - slurm-config:/etc/slurm             # Shared Slurm configuration volume
      - shared-storage:/shared              # Shared storage for job data and MPI binaries
      - user-sync:/user-sync                # User account synchronization
      # Optional: Mount packages.yml for runtime package installation
      - venv:/opt/venv
      - rpm-cache:/var/cache/dnf
      - ./packages.yml:/packages.yml:ro
      - home:/home
      - scratch:/scratch
    healthcheck:
      test: sinfo
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 15s
    networks:
      - slurm-net

  x-slurm-worker-common: &slurm-worker-common
    image: ${REGISTRY}vhpc-worker:${VERSION}
    pull_policy: missing
    build:
      context: .
      dockerfile: Containerfile.slurm-worker
      args:
        - BASE_IMAGE=${REGISTRY}vhpc-base:${VERSION}
      cache_from:
        - vhpc-base:${VERSION}
    volumes:
      - munge-key:/etc/munge:ro
      - slurm-config:/etc/slurm # Shared Slurm configuration volume
      - shared-storage:/shared
      - user-sync:/user-sync:ro
      - venv:/opt/venv:ro
      - rpm-cache:/var/cache/dnf
      - ./packages.yml:/packages.yml:ro
      - home:/home
      - scratch:/scratch
    depends_on:
      slurm-headnode:
        condition: service_healthy
        restart: true
    networks:
      - slurm-net
    deploy:
      replicas: 0

  slurm-worker1:
    <<: *slurm-worker-common
    hostname: slurm-worker1
    # SSH not exposed by default (access via docker exec)
    # Uncomment to expose SSH if needed:
    # ports:
    #   - "127.0.0.1:2223:22"
    deploy:
      replicas: 1

  slurm-worker2:
    <<: *slurm-worker-common
    hostname: slurm-worker2
    # SSH not exposed by default (access via docker exec)
    # Uncomment to expose SSH if needed:
    # ports:
    #   - "127.0.0.1:2224:22"
    deploy:
      replicas: 1

volumes:
  munge-key:
  shared-storage:
  user-sync:
  slurm-db-data:
  slurm-config:
  venv:
  rpm-cache:
  home:
  scratch:

networks:
  slurm-net:
    driver: bridge
